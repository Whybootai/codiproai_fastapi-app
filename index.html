        <div id="surveyStep3" class="survey-step hidden">
            <img class="lazyload" data-src="https://via.placeholder.com/400x200 /4a5568/fff?text=Step+3:+Purchase+Timeline"
                alt="Purchase Timeline">
            <p>How soon are your ideal customers looking to purchase?</p>
            <button onclick="showDownloadOptions('1-3')">1-3 Months</button>
            <button onclick="showDownloadOptions('3-6')">3-6 Months</button>
            <button onclick="showDownloadOptions('6+')">6+ Months</button>
        </div>
    </div>

    <div id="downloadOptions" class="download-options hidden">
        <h2>Choose Your Download Format</h2>
        <p>Select the document format you prefer to download your leads.</p>
        <button onclick="downloadLeads('csv')">Download as CSV</button>
        <button onclick="downloadLeads('pdf')">Download as PDF</button>
    </div>

  <!-- Auth modal -->
  <div class="modal" id="authModal">
        <div class="modal-content">
            <span class="close-button" id="closeModal">Ã—</span>
            <h2>Sign in with Google</h2>
            <div id="g_id_onload"
                data-client_id="690096232363-d8kmh963sah4oo6e8fckotni335q0nse.apps.googleusercontent.com"
                data-callback="handleGoogleSignIn">
             </div>
             <div class="g_id_signin" data-type="standard"></div>
        </div>
    </div>

    <!-- Arizona Dealership Page -->
    <div class="dealership-page" id="dealershipPage">
        <div class="container">
            <h1>Arizona Dealership</h1>
            <h2>Nearby Customers (100+ in your area)</h2>

            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>City</th>
                        <th>Distance</th>
                        <th>Phone</th>
                        <th>Budget</th>
                        <th>Ideal Car</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <button id="downloadBtn">Download Now</button>
            <div class="notification" style="display:none;" id="notification">
                Due to the high volume of customers using our services, please allow up to 48 hours for your download to be
                processed. Thank you for your patience.
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchForm = document.getElementById('searchForm');
            const initialPlaceholder = document.getElementById('initialPlaceholder');
            const generateLeadsButton = document.getElementById('generateLeadsButton');
            const leadFormPopup = document.getElementById('leadFormPopup');
            const customerCountSpan = document.getElementById('customerCount');
            const leadDetailsForm = document.getElementById('leadDetailsForm');
            const timerPopup = document.getElementById('timerPopup');
            const timerDisplay = document.getElementById('timer');
            const signupPopup = document.getElementById('signupPopup');
            const surveyContainer = document.getElementById('surveyContainer');
            const downloadOptions = document.getElementById('downloadOptions');
            const cityInput = document.getElementById('city');
            const citySuggestions = document.getElementById('citySuggestions');
            const citySuggestionsList = document.querySelector('#citySuggestions ul');
            const googleButton = document.getElementById('googleButton');
            const passwordlessSignupButton = document.getElementById('passwordlessSignupButton');
            const passwordlessSignupPopup = document.getElementById('passwordlessSignupPopup');
            const verifyEmailButton = document.getElementById('verifyEmailButton');
            const emailSignupInput = document.getElementById('emailSignup');
            const loadingMessage = timerPopup.querySelector('.loading-message');

            // Error message elements
            const countryError = document.getElementById('countryError');
            const stateError = document.getElementById('stateError');
            const cityError = document.getElementById('cityError');
            const nameError = document.getElementById('nameError');
            const phoneError = document.getElementById('phoneError');
            const dealershipError = document.getElementById('dealershipError');
            const listSizeError = document.getElementById('listSizeError');
            const emailError = document.getElementById('emailError');
            const roleError = document.getElementById('roleError');
            const budgetError = document.getElementById('budgetError');
            const timelineError = document.getElementById('timelineError');
            const adminCodeError = document.getElementById('adminCodeError');
            const adminCodeInput = document.getElementById('adminCode');
            const emailSignupError = document.getElementById('emailSignupError');
             const zipcodeError = document.getElementById('zipcodeError');


            let timerInterval;
            let notificationInterval;
            let currentSuggestionIndex = -1;
            const correctAdminCode = "123456";
            let apiKey = "";
            let googleUser = null;

            //Auth Modal Variables from auth_modal.py
            const authModal = document.getElementById("authModal");
            const closeModalButton = document.getElementById("closeModal");


            // Dealership Page Variables
            const dealershipPage = document.getElementById('dealershipPage');
            const downloadBtn = document.getElementById('downloadBtn');
            const notification = document.getElementById('notification');



            function showNotification(message) {
                const notificationKey = 'notificationShown_' + message.replace(/\s/g, '_');
                if (!localStorage.getItem(notificationKey)) {
                    const notificationDiv = document.createElement('div');
                    notificationDiv.classList.add('notification');
                    notificationDiv.innerHTML = `${message} <br><br> Developed by: Thomas S`;
                    document.body.appendChild(notificationDiv);
                    setTimeout(() => {
                        notificationDiv.classList.add('fade-out');
                        setTimeout(() => {
                            document.body.removeChild(notificationDiv);
                        }, 3000);
                    }, 3000);
                    localStorage.setItem(notificationKey, 'true');
                }
            }

            function getRandomNotification() {
                const notifications = [
                    "New lead generated for a luxury SUV!",
                    "Dealership in your area just got 15 new leads!",
                    "High-income customer looking for a new sedan!",
                    "Family looking to upgrade to a larger vehicle!",
                    "Tech-savvy customer interested in electric cars!"
                ];
                return notifications[Math.floor(Math.random() * notifications.length)];
            }

            function startRandomNotifications() {
                notificationInterval = setInterval(() => {
                    showNotification(getRandomNotification());
                }, 10000);
            }

           async function fetchCitySuggestions(state, query) {
                citySuggestionsList.innerHTML = "";
                if (!state || !query) {
                    citySuggestions.classList.add('hidden');
                    return;
                }
                 // Use a relative URL for the API
                try {
                   const response = await fetch(`/api/cities?stateCode=${state}&cityName=${query}`, {
                        headers: {
                            'Authorization': apiKey,
                        },
                    });
                    if (!response.ok) {
                        console.error(`HTTP error! status: ${response.status}`);
                        citySuggestions.classList.add('hidden');
                        return;
                    }
                    const data = await response.json();
                    if (data && data.cities && data.cities.length > 0) {
                        data.cities.forEach((city, index) => {
                            const li = document.createElement('li');
                            li.textContent = city.name;
                            li.addEventListener('click', () => {
                                cityInput.value = city.name;
                                citySuggestions.classList.add('hidden');
                                currentSuggestionIndex = -1;
                            });
                            // Set the 'active' class for the currently selected suggestion
                            li.addEventListener('mouseover', function () {
                                removeActiveClassFromSuggestions(); // Remove active class from previous suggestion
                                this.classList.add('active');
                                currentSuggestionIndex = index; // Update the current active suggestion index
                            });
                            citySuggestionsList.appendChild(li);
                        });
                        citySuggestions.classList.remove('hidden');
                    } else {
                        citySuggestions.classList.add('hidden');
                    }

                } catch (error) {
                    console.error("Error fetching data:", error);
                }
            }

           function removeActiveClassFromSuggestions() {
                // Remove the 'active' class from all list items in the suggestions list
                const allSuggestions = citySuggestionsList.querySelectorAll('li.active');
                allSuggestions.forEach(item => {
                    item.classList.remove('active');
                });
            }

            cityInput.addEventListener('input', function () {
                const state = document.getElementById('state').value;
                const query = cityInput.value.trim();
                fetchCitySuggestions(state, query);
            });

             // Keyboard navigation for city suggestions
            cityInput.addEventListener('keydown', function (event) {
                if (citySuggestions.classList.contains('hidden')) return;

                const allSuggestions = citySuggestionsList.querySelectorAll('li');
                if (allSuggestions.length === 0) return;
                // Move the active suggestion up
                if (event.key === 'ArrowUp') {
                    event.preventDefault(); // Prevent cursor moving to start of input
                    removeActiveClassFromSuggestions();
                    currentSuggestionIndex--;
                    if (currentSuggestionIndex < 0) {
                        currentSuggestionIndex = allSuggestions.length - 1; // Wrap to last suggestion
                    }
                    allSuggestions[currentSuggestionIndex].classList.add('active');
                }
                // Move the active suggestion down
                else if (event.key === 'ArrowDown') {
                    event.preventDefault(); // Prevent cursor moving to end of input
                    removeActiveClassFromSuggestions();
                    currentSuggestionIndex++;
                    if (currentSuggestionIndex >= allSuggestions.length) {
                        currentSuggestionIndex = 0; // Wrap to first suggestion
                    }
                    allSuggestions[currentSuggestionIndex].classList.add('active');
                }
                // Select the active suggestion and close suggestions
                else if (event.key === 'Enter') {
                    event.preventDefault();
                    if (currentSuggestionIndex !== -1 && allSuggestions[currentSuggestionIndex]) {
                        cityInput.value = allSuggestions[currentSuggestionIndex].textContent;
                    }
                    citySuggestions.classList.add('hidden');
                    currentSuggestionIndex = -1;
                }
                 else if (event.key === 'Escape') {
                    citySuggestions.classList.add('hidden');
                    currentSuggestionIndex = -1;
                }
            });
              // Close suggestions when clicking outside
            document.addEventListener('click', function (event) {
                if (!citySuggestions.contains(event.target) && event.target !== cityInput) {
                    citySuggestions.classList.add('hidden');
                    currentSuggestionIndex = -1; // Reset index when closed
                }
            });


            adminCodeInput.addEventListener('input', function () {
                if (adminCodeInput.value === correctAdminCode) {
                    apiKey = "AIzaSyBSbInj88uaaA3EpXdT9XWkg2cPRKQ49aA";
                    adminCodeError.classList.add('hidden');
                } else {
                    apiKey = "";
                    adminCodeError.classList.remove('hidden');
                }
            });


            searchForm.addEventListener('submit', function (event) {
                event.preventDefault();

                // Reset error messages
                countryError.classList.add('hidden');
                stateError.classList.add('hidden');
                cityError.classList.add('hidden');
                 zipcodeError.classList.add('hidden');


                // Validate form
                let isValid = true;
                const country = document.getElementById('country').value;
                const state = document.getElementById('state').value;
                const city = document.getElementById('city').value;
                 const zipcode = document.getElementById('zipcode').value;


                if (!country) {
                    countryError.classList.remove('hidden');
                    isValid = false;
                }
                if (!state) {
                    stateError.classList.remove('hidden');
                    isValid = false;
                }
                if (!city) {
                    cityError.classList.remove('hidden');
                    isValid = false;
                }
                 if(!/^\d{5}(-\d{4})?$/.test(zipcode)) {
                      zipcodeError.classList.remove('hidden');
                        isValid = false;
                   }


                 if (!apiKey) {
                   adminCodeError.classList.remove('hidden');
                    isValid = false;
                }

                if (isValid) {
                    timerPopup.classList.remove('hidden');
                    let messageIndex = 0;
                    const messages = [
                        "Analyzing Your Ideal Customer",
                        "Fetching Potential Customers",
                        "Applying Advanced Filters",
                        "Finalizing Data"
                    ];
                    loadingMessage.textContent = messages[messageIndex];


                    timerInterval = setInterval(() => {
                        messageIndex++;
                        if(messageIndex < messages.length) {
                            loadingMessage.textContent = messages[messageIndex];
                        } else {
                            clearInterval(timerInterval);
                            timerPopup.classList.add('hidden');
                            const randomCustomers = Math.floor(Math.random() * 1000) + 100;
                            customerCountSpan.textContent = randomCustomers;
                            initialPlaceholder.classList.remove('hidden');
                         }
                     }, 2000);


                }
            });
            generateLeadsButton.addEventListener('click', function () {
                leadFormPopup.classList.remove('hidden');
                initialPlaceholder.classList.add('hidden');
                document.body.classList.add('overflow-hidden');
            });
            leadDetailsForm.addEventListener('submit', function (event) {
                event.preventDefault();

                // Reset error messages
                nameError.classList.add('hidden');
                phoneError.classList.add('hidden');
                dealershipError.classList.add('hidden');
                listSizeError.classList.add('hidden');
                emailError.classList.add('hidden');
                roleError.classList.add('hidden');
                budgetError.classList.add('hidden');
                timelineError.classList.add('hidden');

                // Validate lead form
                let isValid = true;
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const dealership = document.getElementById('dealership').value;
                const listSize = document.getElementById('listSize').value;
                const email = document.getElementById('email').value;
                const role = document.getElementById('role').value;
                const budget = document.getElementById('budget').value;
                const timeline = document.getElementById('timeline').value;


                if (!name) {
                    nameError.classList.remove('hidden');
                    isValid = false;
                }
                if (!/^\d{10}$/.test(phone)) {
                    phoneError.classList.remove('hidden');
                    isValid = false;
                }
                if (!dealership) {
                    dealershipError.classList.remove('hidden');
                    isValid = false;
                }
                if (!listSize || isNaN(listSize) || listSize <= 0) {
                    listSizeError.classList.remove('hidden');
                    isValid = false;
                }
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    emailError.classList.remove('hidden');
                    isValid = false;
                }
                if (!role) {
                    roleError.classList.remove('hidden');
                    isValid = false;
                }
                if (!budget || isNaN(budget) || budget <= 0) {
                    budgetError.classList.remove('hidden');
                    isValid = false;
                }
                if (!timeline) {
                    timelineError.classList.remove('hidden');
                    isValid = false;
                }
                if (isValid) {
                    leadFormPopup.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                     authModal.style.display = "flex";
                    document.body.classList.add('overflow-hidden');
                 }
            });

            showNotification("Welcome to LightningLeads AZ! We're excited to help you generate more leads.");
            startRandomNotifications();


            function scrollToForm() {
                const searchForm = document.getElementById('searchForm');
                searchForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }


           // Initialize Google Sign-in
            google.accounts.id.initialize({
               client_id: '690096232363-d8kmh963sah4oo6e8fckotni335q0nse.apps.googleusercontent.com',
                 callback: handleGoogleSignIn,
            });

           google.accounts.id.renderButton(
                googleButton, // The element ID
                 { theme: "outline", size: "large", text: 'sign_in_with', logo_alignment: 'left' }  // customization attributes
            );


            function handleGoogleSignIn(response) {
                console.log("Google Sign-in Response:", response);
                 if (response.credential) {
                    // Decode the JWT
                   const decoded = JSON.parse(atob(response.credential.split('.')[1]));
                    googleUser = decoded;
                     authModal.style.display = "none";
                    document.body.classList.remove('overflow-hidden');
                     // Redirect to Flask callback endpoint
                     window.location.href = `/google_callback?credential=${response.credential}`;
                 }
           }


           // Passwordless Sign-up
            passwordlessSignupButton.addEventListener('click', function() {
                signupPopup.classList.add('hidden');
               passwordlessSignupPopup.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            });

           verifyEmailButton.addEventListener('click', function() {
               const email = emailSignupInput.value;
               emailSignupError.classList.add('hidden');
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    emailSignupError.classList.remove('hidden');
                    return;
               }
                // Redirect to Flask email verification endpoint
                window.location.href = `/verify_email?email=${email}`;

            });
             // Close signup popup
            signupPopup.addEventListener('click', function (event) {
                if (event.target === signupPopup) {
                    signupPopup.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                    surveyContainer.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');

                }
           });

            // Close passwordless popup
            passwordlessSignupPopup.addEventListener('click', function (event) {
                if (event.target === passwordlessSignupPopup) {
                    passwordlessSignupPopup.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            });
            // Close survey container
            surveyContainer.addEventListener('click', function (event) {
                if (event.target === surveyContainer) {
                   surveyContainer.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
               }
            });


            // Close downloadOptions container
            downloadOptions.addEventListener('click', function (event) {
                if (event.target === downloadOptions) {
                    downloadOptions.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            });

          //Auth Modal Functionality

          // Event listener to open the auth modal
        googleButton.addEventListener("click", () => {
            authModal.style.display = "flex";
          });

          // Event listener to close the auth modal
          closeModalButton.addEventListener("click", () => {
             authModal.style.display = "none";
          });
          // Event listener to close the auth modal if clicked outside
           window.addEventListener("click", (event) => {
             if (event.target === authModal) {
                authModal.style.display = "none";
             }
        });



        // Arizona Dealership page logic:
          const tbody = document.querySelector('.dealership-page tbody');
          for (let i = 0; i < 100; i++) {
            const row = tbody.insertRow();
             row.insertCell().textContent = `Customer ${i + 1}`;
              row.insertCell().textContent = 'Random City';
              row.insertCell().textContent = `${Math.floor(Math.random() * 50) + 1} miles`;
              row.insertCell().textContent = '(XXX) XXX-XXXX';
              row.insertCell().textContent = `$${Math.floor(Math.random() * 50000) + 20000}`;
              row.insertCell().textContent = 'Random Car';
            }


            downloadBtn.addEventListener('click', () => {
                notification.style.display = 'block';
                downloadBtn.style.display = 'none';
             });



            // Show the dealership page after closing all other modals
            const allPopups = [signupPopup, passwordlessSignupPopup,  surveyContainer,downloadOptions, authModal];

           function checkAllPopupsClosed() {
                 return allPopups.every(popup => popup.classList.contains('hidden'));
             }
            function showDealershipPage() {
                if (checkAllPopupsClosed()) {
                 setTimeout(() => {
                    dealershipPage.classList.add('active');
                   }, 500)
               }
               else{
                   requestAnimationFrame(showDealershipPage);
              }
           }
          requestAnimationFrame(showDealershipPage);
        });

        let currentSurveyStep = 1;

        function showSurveyStep(step, selectedOption) {
            document.getElementById('surveyStep' + currentSurveyStep).classList.add('hidden');
            document.getElementById('surveyStep' + step).classList.remove('hidden');
            currentSurveyStep = step;
            if (step === 3) {
                console.log('User selected audience: ', selectedOption)
            }
        }
        function showDownloadOptions(selectedTimeline) {
            document.getElementById('surveyStep' + currentSurveyStep).classList.add('hidden');
            document.getElementById('downloadOptions').classList.remove('hidden');
            document.body.classList.remove('overflow-hidden');
            console.log('User selected timeline: ', selectedTimeline)
        }
        function downloadLeads(format) {
            downloadOptions.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            alert(`Simulating download in ${format} format.`);
        }

    </script>
</body>

</html>
